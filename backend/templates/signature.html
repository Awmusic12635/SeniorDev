<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Signature Form</title>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <script src="http://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

    <!-- signature library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>

    <script>
        function getCookie(cname) {
            var name = cname + "=";
            var decodedCookie = decodeURIComponent(document.cookie);
            var ca = decodedCookie.split(';');
            for(var i = 0; i <ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0) == ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                    return c.substring(name.length, c.length);
                }
            }
            return "";
        }

     $(document).ready(function() {
         $(".clearButton").on('click', function () {
           signaturePad.clear();
        });

         $(".saveButton").on('click', function () {
             if (!signaturePad.isEmpty()){
                 var dataurl = signaturePad.toDataURL();

                 var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
                    bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
                while(n--){
                    u8arr[n] = bstr.charCodeAt(n);
                }
                var blob =  new Blob([u8arr], {type:mime});

                console.log(blob)

                var fd = new FormData();
                fd.append("file", blob, "{{ checkout.id }}.png");

                httpRequest = new XMLHttpRequest();

                var url = "/signatureForm/save/{{ checkout.id }}";
                var sendCSRFtoken = "csrfmiddlewaretoken="+String(getCookie('csrftoken'));
                var sendContent = sendCSRFtoken+"&"+fd;

                console.log(fd);

                httpRequest.open('POST', url, true);
                httpRequest.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

                httpRequest.send(sendContent);

             }

        });

         var canvas = document.querySelector("canvas");
         var signaturePad = new SignaturePad(canvas);

     });


    </script>
</head>
<body>

    <div id="signature-pad">
    <div class="m-signature-pad--body">
      <canvas></canvas>
    </div>
    <div class="m-signature-pad--footer">
      <div class="description">Sign above</div>
      <button type="button" class="clearButton">Clear</button>
      <button type="button" class="saveButton">Save Signature</button>
    </div>
  </div>

    <form method="post" action="/signatureForm/save/{{ checkout.id }}" id="sig_form" style="{display:none}" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" id="data_url">
    </form>
</body>
</html>