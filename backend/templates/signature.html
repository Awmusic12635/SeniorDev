<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Signature Form</title>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <script src="http://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

    <!-- signature library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>

    <script>
        function getCookie(cname) {
            var name = cname + "=";
            var decodedCookie = decodeURIComponent(document.cookie);
            var ca = decodedCookie.split(';');
            for(var i = 0; i <ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0) == ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                    return c.substring(name.length, c.length);
                }
            }
            return "";
        }

        function dataURItoBlob(dataURI) {
            // convert base64/URLEncoded data component to raw binary data held in a string
            var byteString;
            if (dataURI.split(',')[0].indexOf('base64') >= 0)
                byteString = atob(dataURI.split(',')[1]);
            else
                byteString = unescape(dataURI.split(',')[1]);

            // separate out the mime component
            var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];

            // write the bytes of the string to a typed array
            var ia = new Uint8Array(byteString.length);
            for (var i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }

            return new Blob([ia], {type:mimeString});
        }

     $(document).ready(function() {
         $(".clearButton").on('click', function () {
           signaturePad.clear();
        });

         $(".saveButton").on('click', function () {
             if (!signaturePad.isEmpty()){
                 var dataurl = signaturePad.toDataURL();
                 var blob = dataURItoBlob(dataurl);
                console.log(blob)

                var fd = new FormData();
                fd.append("file", blob);

                httpRequest = new XMLHttpRequest();

                var url = "/signatureForm/save/{{ checkout.id }}";
                var sendCSRFtoken = "csrfmiddlewaretoken="+String(getCookie('csrftoken'));
                var sendContent = sendCSRFtoken+"&"+fd;

                console.log(fd);

                httpRequest.open('POST', url, true);
                httpRequest.setRequestHeader("Content-type", "multipart/form-data");
                httpRequest.send(sendContent);

             }

        });

         var canvas = document.querySelector("canvas");
         var signaturePad = new SignaturePad(canvas);

     });


    </script>
</head>
<body>

    <div id="signature-pad">
    <div class="m-signature-pad--body">
      <canvas></canvas>
    </div>
    <div class="m-signature-pad--footer">
      <div class="description">Sign above</div>
      <button type="button" class="clearButton">Clear</button>
      <button type="button" class="saveButton">Save Signature</button>
    </div>
  </div>

    <form method="post" action="/signatureForm/save/{{ checkout.id }}" id="sig_form" style="{display:none}" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" id="data_url">
    </form>
</body>
</html>